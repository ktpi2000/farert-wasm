<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>FareInfo JSON ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { font-family: monospace; margin: 20px; max-width: 1200px; }
        .result { padding: 8px; margin: 3px 0; border-radius: 3px; }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .info { background: #e2e3e5; color: #383d41; }
        button { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a87; }
        .json-display { background: #f8f9fa; padding: 15px; border-left: 3px solid #007cba; white-space: pre-wrap; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ« FareInfo JSON API ãƒ†ã‚¹ãƒˆ</h1>
    <p>ç§»æ¤å…ƒã®FareInfoã‚¯ãƒ©ã‚¹ã‚’å®Œå…¨ã«JSONå½¢å¼ã§å†ç¾ã™ã‚‹ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã§ã™ã€‚</p>
    
    <button onclick="testFareInfoJson()">ğŸ§ª FareInfo JSON ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    <button onclick="testRouteAndFare()">ğŸš„ çµŒè·¯ä½œæˆâ†’é‹è³ƒè¨ˆç®—â†’è©³ç´°è¡¨ç¤º</button>
    <button onclick="clearResults()">ğŸ§¹ çµæœã‚¯ãƒªã‚¢</button>
    
    <div id="status" style="padding: 10px; margin: 10px 0; border-radius: 5px; background: #e2e3e5;">
        WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ä¸­...
    </div>
    
    <div id="results"></div>

    <script>
        let FarertModule = null;
        let moduleReady = false;
        
        // ãƒ­ã‚°é–¢æ•°
        function log(message, status = 'info') {
            const div = document.createElement('div');
            div.className = 'result ' + status;
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            document.getElementById('results').appendChild(div);
            console.log(message);
        }
        
        // JSONè¡¨ç¤ºé–¢æ•°
        function displayJson(title, jsonString) {
            const titleDiv = document.createElement('div');
            titleDiv.className = 'result pass';
            titleDiv.textContent = `${new Date().toLocaleTimeString()} - ${title}`;
            document.getElementById('results').appendChild(titleDiv);
            
            const jsonDiv = document.createElement('div');
            jsonDiv.className = 'json-display';
            try {
                const parsed = JSON.parse(jsonString);
                jsonDiv.textContent = JSON.stringify(parsed, null, 2);
            } catch (e) {
                jsonDiv.textContent = jsonString;
            }
            document.getElementById('results').appendChild(jsonDiv);
        }
        
        // WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
        async function loadModule() {
            try {
                document.getElementById('status').textContent = 'WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...';
                document.getElementById('status').style.background = '#fff3cd';
                
                const module = await import('./dist/farert.js');
                FarertModule = await module.default();
                moduleReady = true;
                
                document.getElementById('status').textContent = 'âœ… WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿å®Œäº†ï¼FareInfo JSON APIæº–å‚™OK';
                document.getElementById('status').style.background = '#d4edda';
                
            } catch (error) {
                document.getElementById('status').textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                document.getElementById('status').style.background = '#f8d7da';
            }
        }
        
        // FareInfo JSON ãƒ†ã‚¹ãƒˆ
        async function testFareInfoJson() {
            if (!moduleReady) return;
            
            log('ğŸ« FareInfo JSON APIãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            
            try {
                // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
                FarertModule.openDatabase();
                log('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šå®Œäº†', 'pass');
                
                // çµŒè·¯ä½œæˆ
                FarertModule.createRoute();
                log('çµŒè·¯ä½œæˆå®Œäº†', 'pass');
                
                // æ±äº¬-å¤§é˜ªã®çµŒè·¯ã‚’ä½œæˆ
                const tokyoId = FarertModule.getStationId('æ±äº¬');
                const osakaId = FarertModule.getStationId('å¤§é˜ª');
                
                if (tokyoId > 0 && osakaId > 0) {
                    FarertModule.addStation(tokyoId);
                    FarertModule.addStation(osakaId);
                    log(`æ±äº¬é§…(ID:${tokyoId})â†’å¤§é˜ªé§…(ID:${osakaId})ã®çµŒè·¯ã‚’ä½œæˆ`, 'pass');
                    
                    // é‹è³ƒè¨ˆç®—å®Ÿè¡Œ
                    const calcResult = FarertModule.calculateFare();
                    log(`é‹è³ƒè¨ˆç®—å®Ÿè¡Œ: ${calcResult === 1 ? 'æˆåŠŸ' : 'å¤±æ•—'}`, calcResult === 1 ? 'pass' : 'fail');
                    
                    if (calcResult === 1) {
                        // FareInfo JSONå–å¾—
                        const fareInfoJson = FarertModule.getFareInfoJson();
                        displayJson('ğŸ“Š FareInfo JSON (å®Œå…¨ãªé‹è³ƒè©³ç´°æƒ…å ±)', fareInfoJson);
                        
                        // JSONå†…å®¹ã®æ¤œè¨¼
                        const fareData = JSON.parse(fareInfoJson);
                        log('JSONè§£ææˆåŠŸ', 'pass');
                        log(`çµæœã‚³ãƒ¼ãƒ‰: ${fareData.result} (0:æˆåŠŸ, 1:ä¸å®Œå…¨, ãã®ä»–:ã‚¨ãƒ©ãƒ¼)`, 'info');
                        log(`å§‹ç‚¹é§…ID: ${fareData.beginStationId}, çµ‚ç‚¹é§…ID: ${fareData.endStationId}`, 'info');
                        log(`ä¼šç¤¾ç·šè·¨ã: ${fareData.isResultCompanyMultipassed}`, 'info');
                        log(`Rule114é©ç”¨: ${fareData.isRule114Applied}`, 'info');
                        
                        // showFare()ã¨ã®æ¯”è¼ƒ
                        const fareString = FarertModule.getFareString();
                        log('', '');
                        log('ğŸ“ showFare()çµæœï¼ˆè¡¨ç¤ºç”¨æ–‡å­—åˆ—ï¼‰:', 'info');
                        const fareDiv = document.createElement('div');
                        fareDiv.className = 'json-display';
                        fareDiv.textContent = fareString;
                        document.getElementById('results').appendChild(fareDiv);
                        
                    } else {
                        log('é‹è³ƒè¨ˆç®—ã«å¤±æ•—ã—ãŸãŸã‚ã€FareInfoå–å¾—ã‚’ã‚¹ã‚­ãƒƒãƒ—', 'fail');
                    }
                } else {
                    log('æ±äº¬é§…ã¾ãŸã¯å¤§é˜ªé§…ã®IDãŒå–å¾—ã§ãã¾ã›ã‚“', 'fail');
                }
                
                log('ğŸ‰ FareInfo JSONãƒ†ã‚¹ãƒˆå®Œäº†', 'pass');
                
            } catch (error) {
                log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'fail');
            }
        }
        
        // è¤‡æ•°çµŒè·¯ã§ã®è©³ç´°ãƒ†ã‚¹ãƒˆ
        async function testRouteAndFare() {
            if (!moduleReady) return;
            
            clearResults();
            log('ğŸš„ è¤‡æ•°çµŒè·¯ã§ã®é‹è³ƒè¨ˆç®—è©³ç´°ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            
            const routes = [
                { from: 'æ±äº¬', to: 'æ–°å®¿', description: 'è¿‘è·é›¢ãƒ»éƒ½å†…' },
                { from: 'æ±äº¬', to: 'å¤§é˜ª', description: 'é•·è·é›¢ãƒ»ä¼šç¤¾è·¨ã' },
                { from: 'æ±äº¬', to: 'ç¥æˆ¸', description: 'è¶…é•·è·é›¢' },
                { from: 'æ–°å®¿', to: 'æ±äº¬', description: 'é€†æ–¹å‘ãƒ†ã‚¹ãƒˆ' }
            ];
            
            try {
                FarertModule.openDatabase();
                
                for (let i = 0; i < routes.length; i++) {
                    const route = routes[i];
                    log(`=== çµŒè·¯ ${i + 1}: ${route.from}â†’${route.to} (${route.description}) ===`, 'info');
                    
                    // æ–°ã—ã„çµŒè·¯ã‚’ä½œæˆ
                    FarertModule.createRoute();
                    
                    const fromId = FarertModule.getStationId(route.from);
                    const toId = FarertModule.getStationId(route.to);
                    
                    if (fromId > 0 && toId > 0) {
                        FarertModule.addStation(fromId);
                        FarertModule.addStation(toId);
                        
                        const calcResult = FarertModule.calculateFare();
                        if (calcResult === 1) {
                            const fareInfoJson = FarertModule.getFareInfoJson();
                            displayJson(`ğŸ« ${route.from}â†’${route.to} é‹è³ƒè©³ç´°`, fareInfoJson);
                        } else {
                            log(`${route.from}â†’${route.to}: é‹è³ƒè¨ˆç®—å¤±æ•—`, 'fail');
                        }
                    } else {
                        log(`${route.from}ã¾ãŸã¯${route.to}ã®é§…IDå–å¾—å¤±æ•—`, 'fail');
                    }
                    
                    // å°‘ã—é–“éš”ã‚’ç©ºã‘ã‚‹
                    if (i < routes.length - 1) {
                        log('', '');
                    }
                }
                
                log('ğŸ‰ è¤‡æ•°çµŒè·¯ãƒ†ã‚¹ãƒˆå®Œäº†', 'pass');
                
            } catch (error) {
                log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'fail');
            }
        }
        
        // çµæœã‚¯ãƒªã‚¢
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('load', loadModule);
    </script>
</body>
</html>