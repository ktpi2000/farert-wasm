<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>è©³ç´°çµŒè·¯ãƒ†ã‚¹ãƒˆ: æ±äº¬â†’æ±æµ·é“ç·šâ†’ç¥æˆ¸â†’å±±é™½ç·šâ†’ä¸‹é–¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; max-width: 1000px; }
        .test-section { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .result { padding: 8px; margin: 3px 0; border-radius: 3px; font-family: monospace; }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .info { background: #e2e3e5; color: #383d41; }
        .warn { background: #fff3cd; color: #856404; }
        .station-info { background: #cce7ff; padding: 10px; margin: 5px 0; border-radius: 3px; }
        .route-step { background: #f0f0f0; padding: 8px; margin: 3px 0; border-left: 4px solid #007cba; }
        button { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a87; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>ğŸš„ è©³ç´°çµŒè·¯ãƒ†ã‚¹ãƒˆ</h1>
    <h2>çµŒè·¯: æ±äº¬ â†’ æ±æµ·é“ç·š â†’ ç¥æˆ¸ â†’ å±±é™½ç·š â†’ ä¸‹é–¢</h2>
    
    <button onclick="runDetailedTest()">ğŸš€ è©³ç´°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    <button onclick="clearResults()">ğŸ§¹ çµæœã‚¯ãƒªã‚¢</button>
    
    <div id="status" style="padding: 10px; margin: 10px 0; border-radius: 5px; background: #e2e3e5;">
        WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­...
    </div>
    
    <div class="test-section">
        <h3>ğŸ“ é§…æƒ…å ±å–å¾—</h3>
        <div id="station-results"></div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ›¤ï¸ è·¯ç·šæƒ…å ±å–å¾—</h3>
        <div id="line-results"></div>
    </div>
    
    <div class="test-section">
        <h3>ğŸš„ çµŒè·¯ä½œæˆãƒ»è¿½åŠ </h3>
        <div id="route-results"></div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ’° é‹è³ƒè¨ˆç®—</h3>
        <div id="fare-results"></div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´°æƒ…å ±</h3>
        <div id="db-results"></div>
    </div>

    <script>
        let FarertModule = null;
        let moduleReady = false;
        
        // ãƒ­ã‚°é–¢æ•°
        function log(containerId, message, status = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'result ' + status;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            container.appendChild(div);
            console.log(message);
        }
        
        // WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
        async function loadModule() {
            try {
                document.getElementById('status').textContent = 'WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...';
                document.getElementById('status').style.background = '#fff3cd';
                
                const module = await import('./dist/farert.js');
                FarertModule = await module.default();
                moduleReady = true;
                
                document.getElementById('status').textContent = 'âœ… WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿å®Œäº†ï¼ãƒ†ã‚¹ãƒˆæº–å‚™OK';
                document.getElementById('status').style.background = '#d4edda';
                
            } catch (error) {
                document.getElementById('status').textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                document.getElementById('status').style.background = '#f8d7da';
            }
        }
        
        // è©³ç´°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runDetailedTest() {
            if (!moduleReady) {
                alert('WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            // çµæœã‚’ã‚¯ãƒªã‚¢
            clearResults();
            
            try {
                // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
                const dbResult = FarertModule.openDatabase();
                log('db-results', `ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š: ${dbResult === 1 ? 'æˆåŠŸ' : 'å¤±æ•—'}`, dbResult === 1 ? 'pass' : 'fail');
                
                // é§…æƒ…å ±è©³ç´°å–å¾—
                await testStationDetails();
                
                // è·¯ç·šæƒ…å ±è©³ç´°å–å¾—
                await testLineDetails();
                
                // çµŒè·¯ä½œæˆè©³ç´°ãƒ†ã‚¹ãƒˆ
                await testRouteCreation();
                
                // é‹è³ƒè¨ˆç®—è©³ç´°ãƒ†ã‚¹ãƒˆ
                await testFareCalculation();
                
                log('db-results', 'ğŸ‰ å…¨ãƒ†ã‚¹ãƒˆå®Œäº†', 'pass');
                
            } catch (error) {
                log('db-results', `âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}`, 'fail');
            }
        }
        
        // é§…æƒ…å ±è©³ç´°ãƒ†ã‚¹ãƒˆ
        async function testStationDetails() {
            const stations = [
                { name: 'æ±äº¬', description: 'é¦–éƒ½åœã®ä¸­å¿ƒé§…' },
                { name: 'ç¥æˆ¸', description: 'é–¢è¥¿ã®ä¸»è¦é§…' },
                { name: 'ä¸‹é–¢', description: 'æœ¬å·æœ€è¥¿ç«¯ã®ä¸»è¦é§…' },
                { name: 'æ–°å®¿', description: 'æ±äº¬ã®å‰¯éƒ½å¿ƒ' },
                { name: 'å¤§é˜ª', description: 'é–¢è¥¿ã®ä¸­å¿ƒé§…' }
            ];
            
            log('station-results', 'ğŸ“ é§…æƒ…å ±è©³ç´°å–å¾—ã‚’é–‹å§‹...', 'info');
            
            let stationTable = '<table><tr><th>é§…å</th><th>é§…ID</th><th>å–å¾—é§…å</th><th>èª¬æ˜</th><th>çŠ¶æ…‹</th></tr>';
            
            for (const station of stations) {
                const stationId = FarertModule.getStationId(station.name);
                const retrievedName = stationId > 0 ? FarertModule.getStationName(stationId) : '';
                const status = stationId > 0 ? 'âœ…' : 'âŒ';
                
                stationTable += `<tr>
                    <td>${station.name}</td>
                    <td>${stationId}</td>
                    <td>${retrievedName}</td>
                    <td>${station.description}</td>
                    <td>${status}</td>
                </tr>`;
                
                log('station-results', 
                    `${station.name}: ID=${stationId}, å–å¾—å="${retrievedName}"`, 
                    stationId > 0 ? 'pass' : 'fail');
            }
            
            stationTable += '</table>';
            
            const tableDiv = document.createElement('div');
            tableDiv.innerHTML = stationTable;
            document.getElementById('station-results').appendChild(tableDiv);
        }
        
        // è·¯ç·šæƒ…å ±è©³ç´°ãƒ†ã‚¹ãƒˆ
        async function testLineDetails() {
            log('line-results', 'ğŸ›¤ï¸ è·¯ç·šæƒ…å ±è©³ç´°å–å¾—ã‚’é–‹å§‹...', 'info');
            
            let lineTable = '<table><tr><th>è·¯ç·šID</th><th>è·¯ç·šå</th><th>çŠ¶æ…‹</th></tr>';
            let foundLines = 0;
            
            // è·¯ç·šIDã‚’1ã‹ã‚‰50ã¾ã§æ¤œç´¢
            for (let lineId = 1; lineId <= 50; lineId++) {
                const lineName = FarertModule.getLineName(lineId);
                if (lineName && lineName.trim().length > 0) {
                    foundLines++;
                    lineTable += `<tr><td>${lineId}</td><td>${lineName}</td><td>âœ…</td></tr>`;
                    
                    // ç‰¹ã«é–¢ä¿‚ã™ã‚‹è·¯ç·šã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    const isTargetLine = lineName.includes('æ±æµ·é“') || 
                                        lineName.includes('å±±é™½') || 
                                        lineName.includes('ä¸­å¤®');
                    
                    log('line-results', 
                        `è·¯ç·šID ${lineId}: "${lineName}"${isTargetLine ? ' â­' : ''}`, 
                        isTargetLine ? 'pass' : 'info');
                    
                    if (foundLines >= 10) break; // æœ€åˆã®10å€‹ã®æœ‰åŠ¹ãªè·¯ç·šã®ã¿è¡¨ç¤º
                }
            }
            
            lineTable += '</table>';
            
            const tableDiv = document.createElement('div');
            tableDiv.innerHTML = lineTable;
            document.getElementById('line-results').appendChild(tableDiv);
            
            log('line-results', `ç™ºè¦‹ã•ã‚ŒãŸè·¯ç·šæ•°: ${foundLines}`, 'info');
        }
        
        // çµŒè·¯ä½œæˆè©³ç´°ãƒ†ã‚¹ãƒˆ
        async function testRouteCreation() {
            log('route-results', 'ğŸš„ çµŒè·¯ä½œæˆè©³ç´°ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...', 'info');
            
            // çµŒè·¯ä½œæˆ
            const createResult = FarertModule.createRoute();
            log('route-results', `çµŒè·¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ: ${createResult === 1 ? 'æˆåŠŸ' : 'å¤±æ•—'}`, 
                createResult === 1 ? 'pass' : 'fail');
            
            // æŒ‡å®šã•ã‚ŒãŸçµŒè·¯ã§ã®é§…è¿½åŠ : æ±äº¬ â†’ ç¥æˆ¸ â†’ ä¸‹é–¢
            const routeStations = ['æ±äº¬', 'ç¥æˆ¸', 'ä¸‹é–¢'];
            let routeHtml = '<div class="station-info"><h4>ğŸ“ çµŒè·¯æ§‹ç¯‰éç¨‹</h4>';
            
            for (let i = 0; i < routeStations.length; i++) {
                const stationName = routeStations[i];
                const stationId = FarertModule.getStationId(stationName);
                
                if (stationId > 0) {
                    const addResult = FarertModule.addStation(stationId);
                    routeHtml += `<div class="route-step">
                        ã‚¹ãƒ†ãƒƒãƒ— ${i + 1}: ${stationName}é§… (ID: ${stationId}) è¿½åŠ  
                        â†’ çµæœ: ${addResult >= 0 ? 'æˆåŠŸ' : 'å¤±æ•—'}
                    </div>`;
                    
                    log('route-results', 
                        `ã‚¹ãƒ†ãƒƒãƒ—${i + 1}: ${stationName}é§…(ID:${stationId})è¿½åŠ  â†’ ${addResult}`, 
                        addResult >= 0 ? 'pass' : 'fail');
                    
                    // çµŒè·¯çŠ¶æ…‹ã‚’ç¢ºèª
                    const currentCount = FarertModule.getRouteCount();
                    const isEnd = FarertModule.isEnd();
                    
                    log('route-results', 
                        `  ç¾åœ¨ã®çµŒè·¯æ•°: ${currentCount}, çµ‚ç«¯: ${isEnd ? 'ã¯ã„' : 'ã„ã„ãˆ'}`, 
                        'info');
                } else {
                    routeHtml += `<div class="route-step" style="background: #f8d7da;">
                        ã‚¹ãƒ†ãƒƒãƒ— ${i + 1}: ${stationName}é§… â†’ é§…IDå–å¾—å¤±æ•—
                    </div>`;
                    
                    log('route-results', `âŒ ${stationName}é§…ã®IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ`, 'fail');
                }
            }
            
            routeHtml += '</div>';
            document.getElementById('route-results').innerHTML += routeHtml;
            
            // æœ€çµ‚çš„ãªçµŒè·¯æƒ…å ±
            const finalCount = FarertModule.getRouteCount();
            const startId = FarertModule.startStationId();
            const lastId = FarertModule.lastStationId();
            
            log('route-results', `ğŸ“Š æœ€çµ‚çµŒè·¯æƒ…å ±: é§…æ•°=${finalCount}, å§‹ç‚¹ID=${startId}, çµ‚ç‚¹ID=${lastId}`, 'info');
        }
        
        // é‹è³ƒè¨ˆç®—è©³ç´°ãƒ†ã‚¹ãƒˆ
        async function testFareCalculation() {
            log('fare-results', 'ğŸ’° é‹è³ƒè¨ˆç®—è©³ç´°ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...', 'info');
            
            try {
                // é‹è³ƒè¨ˆç®—å®Ÿè¡Œ
                const fareResult = FarertModule.calculateFare();
                log('fare-results', `é‹è³ƒè¨ˆç®—å®Ÿè¡Œ: ${fareResult >= 0 ? 'æˆåŠŸ' : 'å¤±æ•—'} (çµæœ: ${fareResult})`, 
                    fareResult >= 0 ? 'pass' : 'fail');
                
                // é‹è³ƒæƒ…å ±å–å¾—
                const fareString = FarertModule.getFareString();
                log('fare-results', `é‹è³ƒæƒ…å ±: "${fareString}"`, 'info');
                
                // é‹è³ƒè¨­å®šã®ãƒ†ã‚¹ãƒˆ
                log('fare-results', 'âš™ï¸ é‹è³ƒè¨­å®šãƒ†ã‚¹ãƒˆ:', 'info');
                
                FarertModule.setLongRoute(1);
                log('fare-results', 'é•·è·é›¢è¨­å®š: æœ‰åŠ¹', 'pass');
                
                FarertModule.setStartAsCity();
                log('fare-results', 'å‡ºç™ºåœ°éƒ½å¸‚å†…è¨­å®š: é©ç”¨', 'pass');
                
                FarertModule.setArriveAsCity();
                log('fare-results', 'åˆ°ç€åœ°éƒ½å¸‚å†…è¨­å®š: é©ç”¨', 'pass');
                
                // å†è¨ˆç®—
                const recalcResult = FarertModule.calculateFare();
                const newFareString = FarertModule.getFareString();
                
                log('fare-results', `è¨­å®šé©ç”¨å¾Œå†è¨ˆç®—: ${recalcResult >= 0 ? 'æˆåŠŸ' : 'å¤±æ•—'} (çµæœ: ${recalcResult})`, 
                    recalcResult >= 0 ? 'pass' : 'fail');
                log('fare-results', `æ–°é‹è³ƒæƒ…å ±: "${newFareString}"`, 'info');
                
                // é‹è³ƒæ¯”è¼ƒ
                if (fareString !== newFareString) {
                    log('fare-results', 'âœ… è¨­å®šå¤‰æ›´ã«ã‚ˆã‚Šé‹è³ƒæƒ…å ±ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ', 'pass');
                } else {
                    log('fare-results', 'âš ï¸ è¨­å®šå¤‰æ›´å¾Œã‚‚é‹è³ƒæƒ…å ±ã«å¤‰åŒ–ãªã—', 'warn');
                }
                
            } catch (error) {
                log('fare-results', `âŒ é‹è³ƒè¨ˆç®—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'fail');
            }
        }
        
        // çµæœã‚¯ãƒªã‚¢
        function clearResults() {
            const resultContainers = ['station-results', 'line-results', 'route-results', 'fare-results', 'db-results'];
            resultContainers.forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('load', loadModule);
    </script>
</body>
</html>