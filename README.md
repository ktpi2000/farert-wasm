# Farert WebAssembly Project

æ—¥æœ¬ã®é‰„é“é‹è³ƒè¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ã®WebAssemblyç§»æ¤ç‰ˆã§ã™ã€‚

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€C/C++ã§å®Ÿè£…ã•ã‚ŒãŸé‰„é“é‹è³ƒè¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ã€ŒFarertã€ã‚’WebAssemblyã«ç§»æ¤ã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œã•ã›ã‚‹ã‚‚ã®ã§ã™ã€‚

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

```
farert-wasm/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core/               # ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆalpdb.cppç­‰ï¼‰
â”‚   â”œâ”€â”€ db/                 # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œï¼ˆSQLite3ï¼‰
â”‚   â”œâ”€â”€ include/            # ãƒ˜ãƒƒãƒ€ãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â””â”€â”€ farert_wasm.cpp     # WebAssembly ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–¢æ•°
â”œâ”€â”€ data/
â”‚   â””â”€â”€ jrdbnewest.db      # é‰„é“ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
â”œâ”€â”€ third_party/
â”‚   â””â”€â”€ sqlite3.c          # SQLite3ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
â”œâ”€â”€ build/                 # ãƒ“ãƒ«ãƒ‰æˆæœç‰©
â”œâ”€â”€ dist/                  # å‡ºåŠ›ã•ã‚Œã‚‹WASMãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ farert_test.html       # ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸
â”œâ”€â”€ Makefile              # ãƒ“ãƒ«ãƒ‰è¨­å®š
â”œâ”€â”€ package.json          # NPMã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ setup_env.sh          # Emscriptenç’°å¢ƒè¨­å®š
â””â”€â”€ CLAUDE.md             # é–‹ç™ºè€…å‘ã‘è©³ç´°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
```

## å‰ææ¡ä»¶

- Emscripten SDK ãŒ `~/priv/farert.repos/emsdk/` ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
- Python 3.xï¼ˆé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ç”¨ï¼‰

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

1. **Emscriptenç’°å¢ƒã®è¨­å®š:**
   ```bash
   source setup_env.sh
   ```

2. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰:**
   ```bash
   make
   # ã¾ãŸã¯
   npm run build
   ```

3. **é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•:**
   ```bash
   make serve
   # ã¾ãŸã¯
   npm run dev
   ```

4. **ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ†ã‚¹ãƒˆ:**
   `http://localhost:8080/farert_test.html` ã‚’é–‹ã„ã¦WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ†ã‚¹ãƒˆ

## åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½

WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ï¼š

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ©Ÿèƒ½
- `openDatabase()` - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
- `closeDatabase()` - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ‡æ–­

### çµŒè·¯ç®¡ç†æ©Ÿèƒ½  
- `createRoute()` - çµŒè·¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
- `destroyRoute()` - çµŒè·¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç ´æ£„
- `addStation(stationId)` - é§…ã‚’çµŒè·¯ã«è¿½åŠ 
- `addRoute(lineId, stationId)` - è·¯ç·šã¨é§…ã‚’çµŒè·¯ã«è¿½åŠ 
- `reverseRoute()` - çµŒè·¯ã‚’é€†è»¢

### é§…ãƒ»è·¯ç·šæ¤œç´¢æ©Ÿèƒ½
- `getStationId(name)` - é§…åã‹ã‚‰IDã‚’å–å¾—
- `getStationName(id)` - IDã‹ã‚‰é§…åã‚’å–å¾—
- `getLineName(id)` - IDã‹ã‚‰è·¯ç·šåã‚’å–å¾—

### é‹è³ƒè¨ˆç®—æ©Ÿèƒ½
- `calculateFare()` - é‹è³ƒè¨ˆç®—å®Ÿè¡Œ
- `getFareString()` - é‹è³ƒæƒ…å ±ã®æ–‡å­—åˆ—å–å¾—

### ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
- `test()` - åŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆ
- `debugStations()` - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…å®¹ç¢ºèª

## Makeã‚³ãƒãƒ³ãƒ‰

- `make` - WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ“ãƒ«ãƒ‰
- `make clean` - ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤
- `make serve` - é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆè‡ªå‹•ãƒãƒ¼ãƒˆé¸æŠï¼‰
- `make status` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®çŠ¶æ³ã‚’è¡¨ç¤º
- `make help` - åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰ä¸€è¦§

## NPMã‚¹ã‚¯ãƒªãƒ—ãƒˆ

- `npm run build` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰
- `npm run clean` - ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤
- `npm run serve` - é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
- `npm run dev` - ãƒ“ãƒ«ãƒ‰ã—ã¦é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
- `npm test` - å…¨ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
- `npm run test:database` - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
- `npm run test:route` - çµŒè·¯ç®¡ç†ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
- `npm run test:fare` - é‹è³ƒè¨ˆç®—ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
- `npm run test:browser` - ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã®æ¡ˆå†…è¡¨ç¤º

## é–‹ç™ºæ–¹æ³•

1. C/C++ã‚³ãƒ¼ãƒ‰ã‚’ `src/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ç·¨é›†
2. `make` ã§ãƒªãƒ“ãƒ«ãƒ‰
3. ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å‹•ä½œç¢ºèª

## ãƒ†ã‚¹ãƒˆæ‰‹é †

WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‹•ä½œç¢ºèªã‚’è¡Œã†ãŸã‚ã®è©³ç´°ãªæ‰‹é †ï¼š

### 1. åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# 1. Emscriptenç’°å¢ƒã®è¨­å®š
source setup_env.sh

# 2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ“ãƒ«ãƒ‰
make

# 3. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
make serve
```

### 2. ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆ
1. ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:8080/farert_test.html` ã‚’é–‹ã
2. ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆã‚’é †ç•ªã«å®Ÿè¡Œï¼š

#### åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ**: SQLite3ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ¥ç¶šç¢ºèª
- **ç°¡å˜ãªçµŒè·¯ãƒ†ã‚¹ãƒˆ**: åŸºæœ¬æ©Ÿèƒ½ã®å‹•ä½œç¢ºèªï¼ˆæˆ»ã‚Šå€¤42ã®ãƒ†ã‚¹ãƒˆï¼‰
- **é§…åæ¤œç´¢ãƒ†ã‚¹ãƒˆ**: æ–‡å­—åˆ—ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã¨é§…åæ¤œç´¢ã®å‹•ä½œç¢ºèª

#### çµŒè·¯è¨ˆç®—ãƒ†ã‚¹ãƒˆ  
- **åŸºæœ¬çµŒè·¯ä½œæˆ**: çµŒè·¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã¨ãƒ¡ãƒ¢ãƒªç®¡ç†
- **é‹è³ƒè¨ˆç®—**: çµŒè·¯ã‹ã‚‰é‹è³ƒè¨ˆç®—ã¾ã§ã®å®Œå…¨ãƒ•ãƒ­ãƒ¼
- **çµŒè·¯é€†è»¢**: çµŒè·¯ã®é€†é †å¤‰æ›æ©Ÿèƒ½

#### è©³ç´°æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
- **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒãƒƒã‚°**: å…¨é–¢æ•°ã®å­˜åœ¨ç¢ºèªã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…å®¹è¡¨ç¤º

### 3. æœŸå¾…ã•ã‚Œã‚‹çµæœ
ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã§ä»¥ä¸‹ã®çµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªï¼š

```
âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæˆåŠŸ
ğŸ§ª åŸºæœ¬ãƒ†ã‚¹ãƒˆçµæœ: 42 (æœŸå¾…å€¤: 42)
ğŸš‰ é§…æ¤œç´¢: æ±äº¬ â†’ ID:XXX â†’ åå‰:æ±äº¬
âœ… çµŒè·¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæˆåŠŸ
ğŸ’° é‹è³ƒè¨ˆç®—ãƒ†ã‚¹ãƒˆçµæœ: æˆåŠŸ
ğŸ—ƒï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…å®¹ (æœ€åˆã®10é§…): [é§…ãƒªã‚¹ãƒˆè¡¨ç¤º]
```

### 4. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ
ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç›´æ¥APIã‚’å‘¼ã³å‡ºã™ã“ã¨ã‚‚å¯èƒ½ï¼š

```javascript
// åŸºæœ¬ãƒ†ã‚¹ãƒˆ
FarertModule.test()                          // â†’ 42

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ
FarertModule.openDatabase()                  // â†’ 1 (æˆåŠŸ)
FarertModule.debugStations()                 // â†’ é§…ãƒªã‚¹ãƒˆæ–‡å­—åˆ—

// é§…ãƒ»è·¯ç·šæ¤œç´¢
FarertModule.getStationId("æ±äº¬")             // â†’ é§…ID
FarertModule.getStationName(1)               // â†’ "é§…å"
FarertModule.getLineName(1)                  // â†’ "è·¯ç·šå"

// çµŒè·¯ãƒ»é‹è³ƒè¨ˆç®—
FarertModule.createRoute()                   // â†’ 1 (æˆåŠŸ)
FarertModule.addStation(1)                   // â†’ çµæœã‚³ãƒ¼ãƒ‰
FarertModule.calculateFare()                 // â†’ 1 (æˆåŠŸ)
FarertModule.getFareString()                 // â†’ é‹è³ƒæƒ…å ±æ–‡å­—åˆ—
```

## ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯åŒ…æ‹¬çš„ãªãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š

### ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆï¼ˆNode.jsï¼‰

```bash
# å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
npm test

# ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm run test:database    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
npm run test:route       # çµŒè·¯ç®¡ç†æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ  
npm run test:fare        # é‹è³ƒè¨ˆç®—æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
npm run test:integration # çµ±åˆãƒ†ã‚¹ãƒˆ

# ç›´æ¥å®Ÿè¡Œï¼ˆã‚ˆã‚Šè©³ç´°ãªåˆ¶å¾¡ï¼‰
node tests/run_tests.js                 # å…¨ãƒ†ã‚¹ãƒˆ
node tests/run_tests.js database        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆã®ã¿
node tests/run_tests.js --help          # ä½¿ç”¨æ–¹æ³•è¡¨ç¤º
```

### ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆ

```bash
# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
npm run serve

# ãƒ–ãƒ©ã‚¦ã‚¶ã§ä»¥ä¸‹ã®URLã‚’é–‹ã
# http://localhost:8080/test_unit.html     # è©³ç´°ãªãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆUI  
# http://localhost:8080/farert_test.html   # åŸºæœ¬çš„ãªå‹•ä½œãƒ†ã‚¹ãƒˆ
```

### ãƒ†ã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒª

- **basic** - åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
- **database** - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ»ç®¡ç†ãƒ†ã‚¹ãƒˆ
- **search** - é§…ãƒ»è·¯ç·šæ¤œç´¢æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
- **route** - çµŒè·¯ä½œæˆãƒ»ç®¡ç†ãƒ†ã‚¹ãƒˆ
- **fare** - é‹è³ƒè¨ˆç®—ãƒ†ã‚¹ãƒˆ
- **debug** - ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
- **error-handling** - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
- **memory** - ãƒ¡ãƒ¢ãƒªç®¡ç†ãƒ†ã‚¹ãƒˆ
- **integration** - çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆå…¨æ©Ÿèƒ½ã®é€£æºç¢ºèªï¼‰

### ãƒ†ã‚¹ãƒˆçµæœã®ä¾‹

```
ğŸ§ª Running all unit tests...

âœ… basic - Basic test function
âœ… database - DatabaseManager.openDatabase  
âœ… search - RouteUtility.getStationId - valid station
âœ… route - Route.createRoute
âœ… fare - CalcRoute.calculateFare
âœ… integration - complete fare calculation flow

ğŸ“Š Final Test Results:
==================================================
Total Tests:    25
âœ… Passed:      23
âŒ Failed:      0  
â­ï¸  Skipped:     2
ğŸ“ˆ Pass Rate:   92.0%
```

## ä½¿ç”¨ä¾‹

```javascript
// ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œä¾‹
const result = FarertModule.test();                    // 42ãŒè¿”ã•ã‚Œã‚‹
const isOpen = FarertModule.openDatabase();           // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
const stationId = FarertModule.getStationId("æ±äº¬");   // é§…IDã‚’å–å¾—
const stationName = FarertModule.getStationName(1);   // é§…åã‚’å–å¾—
const routeCreated = FarertModule.createRoute();      // çµŒè·¯ä½œæˆ
const fareCalculated = FarertModule.calculateFare();  // é‹è³ƒè¨ˆç®—
```

## æŠ€è¡“ä»•æ§˜

- **è¨€èª**: C/C++17
- **WebAssembly**: Emscripten
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: SQLite3 (MEMFS)
- **æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°**: UTF-8
- **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ**: ãƒ¢ãƒ€ãƒ³ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆES6å¯¾å¿œï¼‰

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

1. **`em++: No such file or directory`**
   ```bash
   source setup_env.sh
   ```

2. **ãƒãƒ¼ãƒˆãŒä½¿ç”¨ä¸­**
   - MakefileãŒè‡ªå‹•ã§åˆ¥ãƒãƒ¼ãƒˆã‚’é¸æŠã—ã¾ã™

3. **WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒèª­ã¿è¾¼ã‚ãªã„**
   - ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
   - `make status` ã§ãƒ“ãƒ«ãƒ‰çŠ¶æ³ã‚’ç¢ºèª

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

GPL-3.0 License

## é–‹ç™ºè€…å‘ã‘è©³ç´°æƒ…å ±

è©³ç´°ãªé–‹ç™ºæƒ…å ±ã«ã¤ã„ã¦ã¯ `CLAUDE.md` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚